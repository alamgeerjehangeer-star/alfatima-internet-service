<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Fatima Internet Service</title>
    <style>
        :root {
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-end: #e8ecf1;
            --container-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
            --table-hover: #f9fafb;
            --expiring-bg: #fef3c7;
            --expired-bg: #fee2e2;
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --primary-color: #14b8a6;
            --primary-hover: #0f9888;
            --active-badge: #d1fae5;
            --active-text: #065f46;
            --expiring-badge: #fef3c7;
            --expiring-text: #92400e;
        }

        body.dark-mode {
            --bg-gradient-start: #111827;
            --bg-gradient-end: #1f2937;
            --container-bg: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --card-bg: #1f2937;
            --table-hover: #374151;
            --expiring-bg: #78350f;
            --expired-bg: #7f1d1d;
            --modal-bg: #1f2937;
            --input-bg: #374151;
            --input-border: #4b5563;
            --active-badge: #064e3b;
            --active-text: #6ee7b7;
            --expiring-badge: #78350f;
            --expiring-text: #fcd34d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            transition: background 0.3s ease;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--container-bg);
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .header-text h1 {
            font-size: 1.75em;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .header-text p {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: var(--table-hover);
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--table-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-content h3 {
            font-size: 2em;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-content p {
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .stat-content small {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.blue {
            background: #dbeafe;
            color: #1e40af;
        }

        .stat-icon.green {
            background: #d1fae5;
            color: #065f46;
        }

        .stat-icon.orange {
            background: #fed7aa;
            color: #9a3412;
        }

        .stat-icon.red {
            background: #fecaca;
            color: #991b1b;
        }

        body.dark-mode .stat-icon.blue {
            background: #1e3a8a;
            color: #93c5fd;
        }

        body.dark-mode .stat-icon.green {
            background: #064e3b;
            color: #6ee7b7;
        }

        body.dark-mode .stat-icon.orange {
            background: #78350f;
            color: #fdba74;
        }

        body.dark-mode .stat-icon.red {
            background: #7f1d1d;
            color: #fca5a5;
        }

        .main-content {
            background: var(--container-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .content-header {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.95em;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .filter-select {
            padding: 12px 16px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.95em;
            background: var(--input-bg);
            color: var(--text-primary);
            min-width: 150px;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table thead {
            background: var(--table-hover);
            border-bottom: 1px solid var(--border-color);
        }

        .users-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .users-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .users-table tbody tr {
            transition: all 0.2s;
        }

        .users-table tbody tr:hover {
            background: var(--table-hover);
        }

        .users-table tbody tr.expiring-soon {
            background: var(--expiring-bg);
        }

        .users-table tbody tr.expired {
            background: var(--expired-bg);
        }

        .customer-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .customer-info {
            display: flex;
            flex-direction: column;
        }

        .customer-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .customer-id {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .package-info {
            display: flex;
            flex-direction: column;
        }

        .package-speed {
            color: var(--primary-color);
            font-weight: 600;
        }

        .package-price {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-active {
            background: var(--active-badge);
            color: var(--active-text);
        }

        .status-expiring {
            background: var(--expiring-badge);
            color: var(--expiring-text);
        }

        .status-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        body.dark-mode .status-expired {
            background: #7f1d1d;
            color: #fca5a5;
        }

        /* Renew Modal Balance Calculation Box - Dark Mode */
        body.dark-mode #renewModal .form-group input[readonly] {
            background: var(--input-bg);
            color: var(--text-secondary);
        }

        .balance {
            font-weight: 600;
        }

        .balance.positive {
            color: #dc2626;
        }

        .balance.zero {
            color: #16a34a;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--table-hover);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .icon-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            min-width: 220px;
            z-index: 1000;
            display: none;
            margin-top: 8px;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--table-hover);
        }

        .dropdown-item.danger {
            color: #dc2626;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--modal-bg);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.5em;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .close-modal:hover {
            background: var(--table-hover);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.95em;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .payment-history-list {
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .payment-item {
            background: var(--table-hover);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid var(--primary-color);
        }

        .payment-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .payment-amount {
            font-size: 1.25em;
            font-weight: 700;
            color: #16a34a;
        }

        .payment-date {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .payment-method {
            display: inline-block;
            padding: 4px 8px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 4px;
        }

        body.dark-mode .payment-method {
            background: #064e3b;
            color: #6ee7b7;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--container-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-btn {
            padding: 10px 24px;
            border: none;
            background: var(--table-hover);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .payments-view {
            display: none;
        }

        .payments-view.active {
            display: block;
        }

        .customers-view {
            display: none;
        }

        .customers-view.active {
            display: block;
        }

        .month-selector {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 24px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            animation: slideIn 0.3s;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .notification.success {
            background: #16a34a;
        }

        .notification.error {
            background: #dc2626;
        }

        .notification.info {
            background: #0891b2;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 1.25em;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .content-header {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .table-container {
                overflow-x: scroll;
            }

            .users-table {
                min-width: 900px;
            }

            .bottom-nav {
                padding-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">üì°</div>
                <div class="header-text">
                    <h1>Al-Fatima Internet Service</h1>
                    <p>Internet Consumer Management</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                <button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
                <button class="btn btn-primary" onclick="openAddCustomerModal()">+ Add Customer</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-content">
                    <p>Total Customers</p>
                    <h3 id="totalCustomers">0</h3>
                </div>
                <div class="stat-icon blue">
                    üë•
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-content">
                    <p>Active</p>
                    <h3 id="activeCustomers">0</h3>
                    <small id="activePercentage">0% of total</small>
                </div>
                <div class="stat-icon green">
                    üì°
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-content">
                    <p>Expiring Soon</p>
                    <h3 id="expiringSoon">0</h3>
                    <small>Within 2 days</small>
                </div>
                <div class="stat-icon orange">
                    ‚ö†Ô∏è
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-content">
                    <p>Total Dues</p>
                    <h3 id="totalDues">Rs. 0</h3>
                    <small id="duesCustomers">0 customers</small>
                </div>
                <div class="stat-icon red">
                    üí∞
                </div>
            </div>
        </div>

        <!-- Customers View -->
        <div class="main-content customers-view active" id="customersView">
            <div class="content-header">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchCustomer" placeholder="Search by name, ID, or phone...">
                </div>
                <select class="filter-select" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="expiring">Expiring Soon</option>
                    <option value="expired">Expired</option>
                </select>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="setView('list')">‚ò∞</button>
                    <button class="view-btn" onclick="setView('grid')">‚äû</button>
                </div>
            </div>

            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Contact</th>
                            <th>Package</th>
                            <th>Expiry</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payments View -->
        <div class="main-content payments-view" id="paymentsView">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                <div style="width: 56px; height: 56px; background: var(--primary-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                    üí≥
                </div>
                <div>
                    <h2 style="font-size: 1.75em; margin-bottom: 4px; color: var(--text-primary);">Payment History</h2>
                    <p style="color: var(--text-secondary); font-size: 0.95em;">View all received payments</p>
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-card">
                    <div class="stat-content">
                        <p id="currentMonthName">CURRENT MONTH</p>
                        <h3 id="monthRevenue" style="color: #16a34a;">Rs. 0</h3>
                    </div>
                    <div class="stat-icon green">
                        üíµ
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <p>TRANSACTIONS</p>
                        <h3 id="transactionCount">0</h3>
                    </div>
                    <div class="stat-icon blue">
                        üìã
                    </div>
                </div>
            </div>

            <div class="content-header">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchPayment" placeholder="Search by customer name or ID...">
                </div>
                <select class="filter-select" id="monthFilter">
                    <option value="">All Time</option>
                </select>
            </div>

            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchView('customers')">
            <span>üë•</span> Customers
        </button>
        <button class="nav-btn" onclick="switchView('payments')">
            <span>üí≥</span> Payments
        </button>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="customerModalTitle">Add Customer</h2>
                <button class="close-modal" onclick="closeCustomerModal()">√ó</button>
            </div>
            <form id="customerForm">
                <input type="hidden" id="customerId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>Customer ID *</label>
                        <input type="text" id="customerIdInput" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>WhatsApp Number *</label>
                    <input type="tel" id="whatsappNumber" placeholder="923001234567" required>
                </div>
                <div class="form-group">
                    <label>Package *</label>
                    <select id="packageSelect" required>
                        <option value="">Select Package</option>
                        <option value="17Mbps-1200">17 Mbps - Rs.1,200</option>
                        <option value="23Mbps-1400">23 Mbps - Rs.1,400</option>
                        <option value="28Mbps-1600">28 Mbps - Rs.1,600</option>
                        <option value="33Mbps-1800">33 Mbps - Rs.1,800</option>
                        <option value="45Mbps-2000">45 Mbps - Rs.2,000</option>
                        <option value="60Mbps-2500">60 Mbps - Rs.2,500</option>
                        <option value="100Mbps-3500">100 Mbps - Rs.3,500</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Activation Date *</label>
                        <input type="date" id="activationDate" required>
                    </div>
                    <div class="form-group">
                        <label>Old Arrears</label>
                        <input type="number" id="oldArrears" value="0" min="0">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Customer</button>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Record Payment</h2>
                <button class="close-modal" onclick="closePaymentModal()">√ó</button>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="paymentCustomerId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount Received *</label>
                        <input type="number" id="paymentAmount" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Payment Date *</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method *</label>
                    <select id="paymentMethod" required>
                        <option value="cash">Cash</option>
                        <option value="online">Online Transfer</option>
                        <option value="bank">Bank Deposit</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <input type="text" id="paymentNotes" placeholder="Optional notes">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Record Payment</button>
            </form>
            <div class="payment-history-list" id="paymentHistoryList"></div>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment History</h2>
                <button class="close-modal" onclick="closeHistoryModal()">√ó</button>
            </div>
            <div class="payment-history-list" id="customerHistoryList"></div>
        </div>
    </div>

    <!-- Renew Subscription Modal -->
    <div class="modal" id="renewModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Renew Subscription</h2>
                <button class="close-modal" onclick="closeRenewModal()">√ó</button>
            </div>
            
            <!-- Customer Info -->
            <div style="background: var(--table-hover); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Customer</div>
                <div style="font-size: 1.25em; font-weight: 700; color: var(--text-primary);" id="renewCustomerName"></div>
                <div style="font-size: 0.9em; color: var(--text-secondary);" id="renewCustomerId"></div>
            </div>

            <!-- Current Status -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Current Package</div>
                    <div style="font-size: 1.1em; font-weight: 600; color: var(--text-primary);" id="renewCurrentPackage"></div>
                </div>
                <div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Outstanding Balance</div>
                    <div style="font-size: 1.1em; font-weight: 600;" id="renewOutstandingBalance"></div>
                </div>
            </div>

            <form id="renewForm">
                <input type="hidden" id="renewUserId">
                
                <!-- New Package Selection -->
                <div class="form-group">
                    <label>New Package</label>
                    <select id="renewPackageSelect" required onchange="calculateRenewalBalance()">
                        <option value="17Mbps-1200">17Mbps ‚Äî Rs. 1,200/month</option>
                        <option value="23Mbps-1400">23Mbps ‚Äî Rs. 1,400/month</option>
                        <option value="28Mbps-1600">28Mbps ‚Äî Rs. 1,600/month</option>
                        <option value="33Mbps-1800">33Mbps ‚Äî Rs. 1,800/month</option>
                        <option value="45Mbps-2000">45Mbps ‚Äî Rs. 2,000/month</option>
                        <option value="60Mbps-2500">60Mbps ‚Äî Rs. 2,500/month</option>
                        <option value="100Mbps-3500">100Mbps ‚Äî Rs. 3,500/month</option>
                    </select>
                </div>

                <!-- Dates -->
                <div class="form-row">
                    <div class="form-group">
                        <label>New Activation Date</label>
                        <input type="date" id="renewActivationDate" required readonly style="background: var(--table-hover);">
                    </div>
                    <div class="form-group">
                        <label>New Expiry Date</label>
                        <input type="date" id="renewExpiryDate" required readonly style="background: var(--table-hover);">
                    </div>
                </div>

                <!-- Balance Calculation -->
                <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 12px;">Balance Calculation</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #78350f;">Previous Balance</span>
                        <span style="font-weight: 600; color: #78350f;" id="renewPrevBalance">Rs. 0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #78350f;" id="renewNewPackageLabel">+ New Package (17Mbps)</span>
                        <span style="font-weight: 600; color: #78350f;" id="renewNewPackageAmount">Rs. 1,200</span>
                    </div>
                    <div style="border-top: 2px solid #fbbf24; margin: 12px 0; padding-top: 12px; display: flex; justify-content: space-between;">
                        <span style="font-weight: 700; color: #78350f;">New Total Balance</span>
                        <span style="font-weight: 700; font-size: 1.15em; color: #78350f;" id="renewTotalBalance">Rs. 1,200</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="closeRenewModal()" style="flex: 1;">
                        ‚úï Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        üîÑ Renew Subscription
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Storage
        let customers = JSON.parse(localStorage.getItem('alfatimaCustomers')) || [];
        let currentView = 'customers';
        let activeDropdown = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            setDefaultDates();
            renderDashboard();
            renderCustomers();
            renderPayments();
            initializeSearch();
            populateMonthFilter();
        });

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // View Management
        function switchView(view) {
            currentView = view;
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(view)) {
                    btn.classList.add('active');
                }
            });
            
            if (view === 'customers') {
                document.getElementById('customersView').classList.add('active');
                document.getElementById('paymentsView').classList.remove('active');
                renderCustomers(document.getElementById('searchCustomer').value, 
                               document.getElementById('statusFilter').value);
            } else if (view === 'payments') {
                document.getElementById('customersView').classList.remove('active');
                document.getElementById('paymentsView').classList.add('active');
                populateMonthFilter();
                renderPayments(document.getElementById('searchPayment').value, 
                              document.getElementById('monthFilter').value);
            }
        }

        function setView(type) {
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('activationDate').value = today;
            document.getElementById('paymentDate').value = today;
        }

        // Generate avatar initials
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        // Generate random color
        function getAvatarColor(name) {
            const colors = ['#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4'];
            const index = name.charCodeAt(0) % colors.length;
            return colors[index];
        }

        // Dashboard Statistics
        function renderDashboard() {
            const now = new Date();
            const twoDaysLater = new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000);

            const active = customers.filter(c => new Date(c.expiryDate) > now);
            const expiring = customers.filter(c => {
                const exp = new Date(c.expiryDate);
                return exp > now && exp <= twoDaysLater;
            });
            const totalDues = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
            const duesCount = customers.filter(c => c.balance > 0).length;

            document.getElementById('totalCustomers').textContent = customers.length;
            document.getElementById('activeCustomers').textContent = active.length;
            document.getElementById('activePercentage').textContent = 
                `${customers.length > 0 ? Math.round((active.length / customers.length) * 100) : 0}% of total`;
            document.getElementById('expiringSoon').textContent = expiring.length;
            document.getElementById('totalDues').textContent = `Rs. ${totalDues.toLocaleString()}`;
            document.getElementById('duesCustomers').textContent = `${duesCount} customers`;
        }

        // Render Customers Table
        function renderCustomers(filter = '', statusFilter = 'all') {
            const tbody = document.getElementById('customersTableBody');
            const now = new Date();
            const twoDaysLater = new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000);

            let filtered = customers.filter(customer => {
                const matchesSearch = customer.name.toLowerCase().includes(filter.toLowerCase()) ||
                                    customer.customerId.toLowerCase().includes(filter.toLowerCase()) ||
                                    customer.phone.includes(filter);
                
                if (!matchesSearch) return false;

                const expiry = new Date(customer.expiryDate);
                
                if (statusFilter === 'active') return expiry > now;
                if (statusFilter === 'expiring') return expiry > now && expiry <= twoDaysLater;
                if (statusFilter === 'expired') return expiry <= now;
                
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <h3>No customers found</h3>
                                <p>Start by adding your first customer</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(customer => {
                const expiry = new Date(customer.expiryDate);
                const daysUntil = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                
                let status = 'active';
                let statusText = 'active';
                let rowClass = '';
                
                if (expiry <= now) {
                    status = 'expired';
                    statusText = 'expired';
                    rowClass = 'expired';
                } else if (expiry <= twoDaysLater) {
                    status = 'expiring';
                    statusText = 'expiring';
                    rowClass = 'expiring-soon';
                }

                const balanceClass = customer.balance > 0 ? 'positive' : customer.balance < 0 ? 'zero' : 'zero';
                const balanceDisplay = customer.balance < 0 
                    ? `(Credit: ${Math.abs(customer.balance).toLocaleString()})` 
                    : customer.balance.toLocaleString();
                const avatarColor = getAvatarColor(customer.name);

                return `
                    <tr class="${rowClass}">
                        <td>
                            <div class="customer-cell">
                                <div class="avatar" style="background: ${avatarColor}">
                                    ${getInitials(customer.name)}
                                </div>
                                <div class="customer-info">
                                    <div class="customer-name">${customer.name}</div>
                                    <div class="customer-id">${customer.customerId}</div>
                                </div>
                            </div>
                        </td>
                        <td>${customer.phone}</td>
                        <td>
                            <div class="package-info">
                                <div class="package-speed">${customer.packageSpeed}</div>
                                <div class="package-price">Rs.${customer.packagePrice.toLocaleString()}</div>
                            </div>
                        </td>
                        <td>${formatDate(customer.expiryDate)}</td>
                        <td><span class="balance ${balanceClass}">Rs. ${balanceDisplay}</span></td>
                        <td><span class="status-badge status-${status}">${statusText}</span></td>
                        <td>
                            <div class="actions-cell">
                                <button class="icon-btn" onclick="sendWhatsAppMessage(${customer.id})" title="WhatsApp">üí¨</button>
                                <div class="dropdown">
                                    <button class="icon-btn" onclick="toggleDropdown(event, ${customer.id})">‚ãÆ</button>
                                    <div class="dropdown-menu" id="dropdown-${customer.id}">
                                        <div class="dropdown-item" onclick="closeDropdowns(); openEditModal(${customer.id})">
                                            ‚úèÔ∏è Edit
                                        </div>
                                        <div class="dropdown-item" onclick="closeDropdowns(); openPaymentModal(${customer.id})">
                                            üí≥ Record Payment
                                        </div>
                                        <div class="dropdown-item" onclick="closeDropdowns(); renewSubscription(${customer.id})">
                                            üîÑ Renew Subscription
                                        </div>
                                        <div class="dropdown-item" onclick="closeDropdowns(); viewPaymentHistory(${customer.id})">
                                            üìú Payment History
                                        </div>
                                        <div class="dropdown-item" onclick="closeDropdowns(); sendPaymentReminder(${customer.id})">
                                            üí¨ SMS: Payment Reminder
                                        </div>
                                        <div class="dropdown-item" onclick="closeDropdowns(); sendExpiryReminder(${customer.id})">
                                            ‚è∞ SMS: Expiry Reminder
                                        </div>
                                        <div class="dropdown-item" onclick="closeDropdowns(); printReceipt(${customer.id})">
                                            üñ®Ô∏è Print Receipt
                                        </div>
                                        <div class="dropdown-item danger" onclick="closeDropdowns(); deleteCustomer(${customer.id})">
                                            üóëÔ∏è Delete
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Dropdown Management
        function toggleDropdown(event, customerId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${customerId}`);
            
            // Close other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(d => {
                if (d !== dropdown) d.classList.remove('active');
            });
            
            dropdown.classList.toggle('active');
        }

        function closeDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active'));
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function() {
            closeDropdowns();
        });

        // Customer Modal
        function openAddCustomerModal() {
            document.getElementById('customerModalTitle').textContent = 'Add Customer';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            setDefaultDates();
            document.getElementById('customerModal').classList.add('active');
        }

        function openEditModal(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            document.getElementById('customerModalTitle').textContent = 'Edit Customer';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerIdInput').value = customer.customerId;
            document.getElementById('whatsappNumber').value = customer.phone;
            document.getElementById('packageSelect').value = `${customer.packageSpeed}-${customer.packagePrice}`;
            document.getElementById('activationDate').value = customer.activationDate.split('T')[0];
            document.getElementById('oldArrears').value = customer.oldArrears;
            
            document.getElementById('customerModal').classList.add('active');
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.remove('active');
        }

        // Customer Form Submit
        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('customerId').value;
            const packageInfo = document.getElementById('packageSelect').value.split('-');
            const activationDate = new Date(document.getElementById('activationDate').value);
            const expiryDate = new Date(activationDate);
            expiryDate.setMonth(expiryDate.getMonth() + 1);

            const customerData = {
                name: document.getElementById('customerName').value.trim(),
                customerId: document.getElementById('customerIdInput').value.trim(),
                phone: document.getElementById('whatsappNumber').value.trim(),
                packageSpeed: packageInfo[0],
                packagePrice: parseInt(packageInfo[1]),
                activationDate: activationDate.toISOString(),
                expiryDate: expiryDate.toISOString(),
                oldArrears: parseInt(document.getElementById('oldArrears').value) || 0,
                payments: [],
                totalPaid: 0
            };

            if (id) {
                // Edit existing
                const index = customers.findIndex(c => c.id === parseInt(id));
                customers[index] = { ...customers[index], ...customerData };
                showNotification('Customer updated successfully!', 'success');
            } else {
                // Add new customer
                if (customers.some(c => c.customerId === customerData.customerId)) {
                    showNotification('Customer ID already exists!', 'error');
                    return;
                }
                customerData.id = Date.now();
                // Initial balance = old arrears + current month package price
                customerData.balance = customerData.oldArrears + customerData.packagePrice;
                // Store cycle info for payment deletion purposes
                customerData.cycleOldArrears = customerData.oldArrears;
                customerData.cyclePackagePrice = customerData.packagePrice;
                customers.push(customerData);
                showNotification('Customer added successfully!', 'success');
            }

            saveCustomers();
            closeCustomerModal();
            renderDashboard();
            renderCustomers(document.getElementById('searchCustomer').value, 
                           document.getElementById('statusFilter').value);
        });

        // Payment Modal
        // Payment Modal
        function openPaymentModal(customerId) {
            // Close all dropdowns first
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active'));
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('Customer not found!', 'error');
                return;
            }

            document.getElementById('paymentCustomerId').value = customerId;
            document.getElementById('paymentAmount').value = customer.balance > 0 ? customer.balance : customer.packagePrice;
            document.getElementById('paymentModal').classList.add('active');
            
            renderCustomerPaymentHistory(customer);
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentForm').reset();
            setDefaultDates();
        }

        function renderCustomerPaymentHistory(customer) {
            const list = document.getElementById('paymentHistoryList');
            
            if (!customer.payments || customer.payments.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); margin-top: 20px;">No payment history</p>';
                return;
            }

            list.innerHTML = `
                <h3 style="margin: 20px 0 16px; color: var(--text-primary);">Payment History</h3>
                ${customer.payments.map((p, index) => `
                    <div class="payment-item">
                        <div class="payment-item-header">
                            <span class="payment-amount">Rs. ${p.amount.toLocaleString()}</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="payment-date">${formatDate(p.date)}</span>
                                <button class="icon-btn" onclick="deletePayment(${customer.id}, ${index})" title="Delete Payment" style="background: #fee2e2; color: #dc2626;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <span class="payment-method">üíµ ${p.method}</span>
                        ${p.notes ? `<p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9em;">${p.notes}</p>` : ''}
                    </div>
                `).join('')}
            `;
        }

        // Delete Payment Function
        function deletePayment(customerId, paymentIndex) {
            if (!confirm('Are you sure you want to delete this payment? This will recalculate the balance.')) return;
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.payments || !customer.payments[paymentIndex]) return;

            const deletedPayment = customer.payments[paymentIndex];
            
            // Remove the payment
            customer.payments.splice(paymentIndex, 1);
            
            // Recalculate total paid
            customer.totalPaid = customer.payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Recalculate balance using stored cycle info
            const cycleOldArrears = customer.cycleOldArrears !== undefined ? customer.cycleOldArrears : customer.oldArrears;
            const cyclePackagePrice = customer.cyclePackagePrice !== undefined ? customer.cyclePackagePrice : customer.packagePrice;
            const cycleTotal = cycleOldArrears + cyclePackagePrice;
            customer.balance = cycleTotal - customer.totalPaid;
            
            saveCustomers();
            showNotification(`Payment of Rs.${deletedPayment.amount.toLocaleString()} deleted! Balance is now Rs.${customer.balance.toLocaleString()}`, 'success');
            
            // Refresh the payment history display
            renderCustomerPaymentHistory(customer);
            
            // Refresh the main view
            renderDashboard();
            renderCustomers(document.getElementById('searchCustomer').value, 
                           document.getElementById('statusFilter').value);
            renderPayments();
        }

        // Payment Form Submit
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = parseInt(document.getElementById('paymentCustomerId').value);
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) return;

            const amount = parseInt(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('paymentNotes').value;

            const payment = {
                id: Date.now(),
                amount: amount,
                date: date,
                method: method,
                notes: notes,
                customerId: customerId,
                customerName: customer.name
            };

            if (!customer.payments) customer.payments = [];
            
            // Store original cycle info if not already stored (for deletion purposes)
            if (customer.cycleOldArrears === undefined) {
                customer.cycleOldArrears = customer.oldArrears;
            }
            if (customer.cyclePackagePrice === undefined) {
                customer.cyclePackagePrice = customer.packagePrice;
            }
            
            customer.payments.push(payment);
            customer.totalPaid += amount;
            
            // Calculate new balance (current dues - total paid)
            customer.balance = customer.oldArrears + customer.packagePrice - customer.totalPaid;
            
            // Payment only updates balance - NO expiry extension
            // To extend expiry, user must click "Renew Subscription" button
            
            if (customer.balance <= 0) {
                showNotification(`Payment recorded! Balance cleared. Use "Renew Subscription" to extend expiry.`, 'success');
            } else {
                showNotification(`Payment recorded! Remaining balance: Rs.${customer.balance}`, 'success');
            }

            saveCustomers();
            closePaymentModal();
            renderDashboard();
            renderCustomers(document.getElementById('searchCustomer').value, 
                           document.getElementById('statusFilter').value);
            renderPayments();
        });

        // Renew Subscription - Open modal with details (works with any balance)
        function renewSubscription(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            // Close dropdown
            closeDropdowns();

            // Populate modal with customer data
            document.getElementById('renewUserId').value = customer.id;
            document.getElementById('renewCustomerName').textContent = customer.name;
            document.getElementById('renewCustomerId').textContent = `ID: ${customer.customerId}`;
            document.getElementById('renewCurrentPackage').textContent = customer.packageSpeed;
            
            // Show balance with appropriate color
            const balanceColor = customer.balance > 0 ? '#dc2626' : customer.balance < 0 ? '#16a34a' : '#16a34a';
            const balanceText = customer.balance > 0 ? `Rs. ${customer.balance.toLocaleString()}` : 
                               customer.balance < 0 ? `Rs. ${Math.abs(customer.balance).toLocaleString()} (Credit)` : 
                               'Rs. 0';
            document.getElementById('renewOutstandingBalance').innerHTML = `<span style="color: ${balanceColor}">${balanceText}</span>`;
            
            // Set current package as default selection
            document.getElementById('renewPackageSelect').value = `${customer.packageSpeed}-${customer.packagePrice}`;
            
            // Calculate new dates
            const currentExpiry = new Date(customer.expiryDate);
            const today = new Date();
            let newActivationDate = currentExpiry < today ? new Date(today) : new Date(currentExpiry);
            newActivationDate.setDate(newActivationDate.getDate() + 1); // Next day after expiry
            
            let newExpiryDate = new Date(newActivationDate);
            newExpiryDate.setMonth(newExpiryDate.getMonth() + 1);
            
            document.getElementById('renewActivationDate').value = newActivationDate.toISOString().split('T')[0];
            document.getElementById('renewExpiryDate').value = newExpiryDate.toISOString().split('T')[0];
            
            // Calculate initial balance
            calculateRenewalBalance();
            
            // Show modal
            document.getElementById('renewModal').classList.add('active');
        }

        function closeRenewModal() {
            document.getElementById('renewModal').classList.remove('active');
            document.getElementById('renewForm').reset();
        }

        function calculateRenewalBalance() {
            const customerId = parseInt(document.getElementById('renewUserId').value);
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const packageInfo = document.getElementById('renewPackageSelect').value.split('-');
            const packageSpeed = packageInfo[0];
            const packagePrice = parseInt(packageInfo[1]);

            // Update labels
            document.getElementById('renewNewPackageLabel').textContent = `+ New Package (${packageSpeed})`;
            document.getElementById('renewNewPackageAmount').textContent = `Rs. ${packagePrice.toLocaleString()}`;
            
            // Calculate total
            const prevBalance = customer.balance;
            const totalBalance = prevBalance + packagePrice;
            
            document.getElementById('renewPrevBalance').textContent = `Rs. ${prevBalance.toLocaleString()}`;
            document.getElementById('renewTotalBalance').textContent = `Rs. ${totalBalance.toLocaleString()}`;
        }

        // Handle Renew Form Submission
        document.getElementById('renewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = parseInt(document.getElementById('renewUserId').value);
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const packageInfo = document.getElementById('renewPackageSelect').value.split('-');
            const newPackageSpeed = packageInfo[0];
            const newPackagePrice = parseInt(packageInfo[1]);
            const newExpiryDate = document.getElementById('renewExpiryDate').value;

            // Update customer
            customer.packageSpeed = newPackageSpeed;
            customer.packagePrice = newPackagePrice;
            customer.expiryDate = new Date(newExpiryDate).toISOString();
            
            // Start new billing cycle
            customer.oldArrears = customer.balance; // Previous balance becomes old arrears
            customer.totalPaid = 0;
            customer.balance = customer.packagePrice + customer.oldArrears;
            
            // Update cycle info
            customer.cycleOldArrears = customer.oldArrears;
            customer.cyclePackagePrice = customer.packagePrice;

            saveCustomers();
            closeRenewModal();
            
            showNotification(`Subscription renewed! Expiry: ${formatDate(newExpiryDate)}. New balance: Rs.${customer.balance.toLocaleString()}`, 'success');
            
            renderDashboard();
            renderCustomers(document.getElementById('searchCustomer').value, 
                           document.getElementById('statusFilter').value);
        });

        // Payment History Modal
        function viewPaymentHistory(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const list = document.getElementById('customerHistoryList');
            
            if (!customer.payments || customer.payments.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No payment history</p>';
            } else {
                list.innerHTML = customer.payments.map((p, index) => `
                    <div class="payment-item">
                        <div class="payment-item-header">
                            <span class="payment-amount">Rs. ${p.amount.toLocaleString()}</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="payment-date">${formatDate(p.date)}</span>
                                <button class="icon-btn" onclick="deletePaymentFromHistory(${customer.id}, ${index})" title="Delete Payment" style="background: #fee2e2; color: #dc2626;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <span class="payment-method">üíµ ${p.method}</span>
                        ${p.notes ? `<p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9em;">${p.notes}</p>` : ''}
                    </div>
                `).join('');
            }

            document.getElementById('historyModal').classList.add('active');
        }

        // Delete payment from history modal
        function deletePaymentFromHistory(customerId, paymentIndex) {
            if (!confirm('Are you sure you want to delete this payment? This will recalculate the balance.')) return;
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.payments || !customer.payments[paymentIndex]) return;

            const deletedPayment = customer.payments[paymentIndex];
            
            // Remove the payment
            customer.payments.splice(paymentIndex, 1);
            
            // Recalculate total paid
            customer.totalPaid = customer.payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Recalculate balance using stored cycle info
            const cycleOldArrears = customer.cycleOldArrears !== undefined ? customer.cycleOldArrears : customer.oldArrears;
            const cyclePackagePrice = customer.cyclePackagePrice !== undefined ? customer.cyclePackagePrice : customer.packagePrice;
            const cycleTotal = cycleOldArrears + cyclePackagePrice;
            customer.balance = cycleTotal - customer.totalPaid;
            
            saveCustomers();
            showNotification(`Payment of Rs.${deletedPayment.amount.toLocaleString()} deleted! Balance is now Rs.${customer.balance.toLocaleString()}`, 'success');
            
            // Refresh the history modal display
            viewPaymentHistory(customerId);
            
            // Refresh the main view
            renderDashboard();
            renderCustomers(document.getElementById('searchCustomer').value, 
                           document.getElementById('statusFilter').value);
            renderPayments();
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // WhatsApp & SMS Functions
        function sendWhatsAppMessage(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const balanceText = customer.balance > 0 
                ? `üí≥ Balance Due: Rs.${customer.balance}`
                : customer.balance < 0 
                ? `‚úÖ Credit: Rs.${Math.abs(customer.balance)}`
                : `‚úÖ Paid`;

            const message = `Hello ${customer.name}!

Your internet package details:
üì¶ Package: ${customer.packageSpeed}
üí∞ Monthly: Rs.${customer.packagePrice}
üìÖ Expiry: ${formatDate(customer.expiryDate)}
${balanceText}

${customer.balance > 0 ? 'Please make your payment to continue service.' : 'Thank you for your payment!'}

Al-Fatima Internet Service`;

            const url = `https://wa.me/${customer.phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function sendPaymentReminder(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            if (customer.balance <= 0) {
                showNotification('No outstanding balance!', 'info');
                return;
            }

            const message = `Payment Reminder

Dear ${customer.name},
Your payment of Rs.${customer.balance} is due.

Package: ${customer.packageSpeed}
Expiry: ${formatDate(customer.expiryDate)}

Please pay at your earliest convenience.

Al-Fatima Internet Service`;

            const url = `https://wa.me/${customer.phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showNotification('Payment reminder sent!', 'info');
        }

        function sendExpiryReminder(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const message = `Expiry Reminder

Dear ${customer.name},
Your internet package expires on ${formatDate(customer.expiryDate)}.

Package: ${customer.packageSpeed}
Amount: Rs.${customer.packagePrice}

Please renew to avoid service interruption.

Al-Fatima Internet Service`;

            const url = `https://wa.me/${customer.phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showNotification('Expiry reminder sent!', 'info');
        }

        // Print Receipt
        function printReceipt(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const lastPayment = customer.payments && customer.payments.length > 0 
                ? customer.payments[customer.payments.length - 1] 
                : null;

            const balanceText = customer.balance > 0 
                ? `Rs.${customer.balance} (Due)`
                : customer.balance < 0 
                ? `Rs.${Math.abs(customer.balance)} (Credit)`
                : `Rs.0 (Paid)`;

            const receiptWindow = window.open('', '_blank');
            receiptWindow.document.write(`
                <html>
                <head>
                    <title>Receipt - ${customer.name}</title>
                    <style>
                        body { font-family: Arial; padding: 40px; }
                        h1 { color: #14b8a6; }
                        .details { margin: 20px 0; }
                        .row { margin: 10px 0; }
                        .label { font-weight: bold; display: inline-block; width: 150px; }
                    </style>
                </head>
                <body>
                    <h1>Al-Fatima Internet Service</h1>
                    <h2>Customer Receipt</h2>
                    <div class="details">
                        <div class="row"><span class="label">Customer Name:</span> ${customer.name}</div>
                        <div class="row"><span class="label">Customer ID:</span> ${customer.customerId}</div>
                        <div class="row"><span class="label">Phone:</span> ${customer.phone}</div>
                        <div class="row"><span class="label">Package:</span> ${customer.packageSpeed}</div>
                        <div class="row"><span class="label">Monthly Fee:</span> Rs.${customer.packagePrice}</div>
                        <div class="row"><span class="label">Expiry Date:</span> ${formatDate(customer.expiryDate)}</div>
                        <div class="row"><span class="label">Current Balance:</span> ${balanceText}</div>
                        ${lastPayment ? `
                        <hr>
                        <h3>Last Payment</h3>
                        <div class="row"><span class="label">Amount:</span> Rs.${lastPayment.amount}</div>
                        <div class="row"><span class="label">Date:</span> ${formatDate(lastPayment.date)}</div>
                        <div class="row"><span class="label">Method:</span> ${lastPayment.method}</div>
                        ` : ''}
                    </div>
                    <p>Thank you for your business!</p>
                </body>
                </html>
            `);
            receiptWindow.document.close();
            receiptWindow.print();
        }

        // Delete Customer
        function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            customers = customers.filter(c => c.id !== customerId);
            saveCustomers();
            showNotification('Customer deleted successfully!', 'success');
            renderDashboard();
            renderCustomers(document.getElementById('searchCustomer').value, 
                           document.getElementById('statusFilter').value);
        }

        // Render Payments
        function renderPayments(search = '', monthFilter = '') {
            const tbody = document.getElementById('paymentsTableBody');
            const currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthName').textContent = currentMonth.toUpperCase();

            // Collect all payments from all customers
            let allPayments = [];
            customers.forEach(customer => {
                if (customer.payments) {
                    customer.payments.forEach(payment => {
                        allPayments.push({
                            ...payment,
                            customerName: customer.name,
                            customerId: customer.customerId,
                            customerAvatar: getInitials(customer.name),
                            avatarColor: getAvatarColor(customer.name)
                        });
                    });
                }
            });

            // Sort by date descending
            allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Filter
            let filtered = allPayments.filter(p => {
                const matchesSearch = p.customerName.toLowerCase().includes(search.toLowerCase()) ||
                                    p.customerId.toLowerCase().includes(search.toLowerCase());
                
                if (!matchesSearch) return false;

                if (monthFilter) {
                    const paymentMonth = new Date(p.date).toLocaleString('default', { month: 'long', year: 'numeric' });
                    return paymentMonth === monthFilter;
                }

                return true;
            });

            // Calculate current month stats
            const currentMonthPayments = allPayments.filter(p => {
                const paymentMonth = new Date(p.date).toLocaleString('default', { month: 'long', year: 'numeric' });
                return paymentMonth === currentMonth;
            });

            const monthRevenue = currentMonthPayments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('monthRevenue').textContent = `Rs. ${monthRevenue.toLocaleString()}`;
            document.getElementById('transactionCount').textContent = filtered.length;

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <h3>No payments found</h3>
                                <p>Payments will appear here once recorded</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(payment => `
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="avatar" style="background: ${payment.avatarColor}">
                                ${payment.customerAvatar}
                            </div>
                            <div class="customer-info">
                                <div class="customer-name">${payment.customerName}</div>
                                <div class="customer-id">${payment.customerId}</div>
                            </div>
                        </div>
                    </td>
                    <td>${formatDate(payment.date)}</td>
                    <td style="color: #16a34a; font-weight: 600;">Rs. ${payment.amount.toLocaleString()}</td>
                    <td><span class="payment-method">üíµ ${payment.method}</span></td>
                    <td style="color: var(--text-secondary);">${payment.notes || '-'}</td>
                </tr>
            `).join('');
        }

        // Populate month filter
        function populateMonthFilter() {
            const select = document.getElementById('monthFilter');
            const months = new Set();

            customers.forEach(customer => {
                if (customer.payments) {
                    customer.payments.forEach(payment => {
                        const month = new Date(payment.date).toLocaleString('default', { month: 'long', year: 'numeric' });
                        months.add(month);
                    });
                }
            });

            const sortedMonths = Array.from(months).sort((a, b) => {
                return new Date(b) - new Date(a);
            });

            select.innerHTML = '<option value="">All Time</option>' + 
                sortedMonths.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        // Search functionality
        function initializeSearch() {
            document.getElementById('searchCustomer').addEventListener('input', function(e) {
                renderCustomers(e.target.value, document.getElementById('statusFilter').value);
            });

            document.getElementById('statusFilter').addEventListener('change', function(e) {
                renderCustomers(document.getElementById('searchCustomer').value, e.target.value);
            });

            document.getElementById('searchPayment').addEventListener('input', function(e) {
                renderPayments(e.target.value, document.getElementById('monthFilter').value);
            });

            document.getElementById('monthFilter').addEventListener('change', function(e) {
                renderPayments(document.getElementById('searchPayment').value, e.target.value);
            });
        }

        // Export Data
        function exportData() {
            const dataStr = JSON.stringify(customers, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `alfatima-customers-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('Data exported successfully!', 'success');
        }

        // Utility Functions
        function saveCustomers() {
            localStorage.setItem('alfatimaCustomers', JSON.stringify(customers));
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>